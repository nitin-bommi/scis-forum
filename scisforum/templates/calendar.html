{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.css" />
{% endblock %}

{% block script %}
<script src='http://fullcalendar.io/js/fullcalendar-2.1.1/lib/moment.min.js'></script>
<script src='http://fullcalendar.io/js/fullcalendar-2.1.1/lib/jquery.min.js'></script>
<script src="http://fullcalendar.io/js/fullcalendar-2.1.1/lib/jquery-ui.custom.min.js"></script>
<script src='http://fullcalendar.io/js/fullcalendar-2.1.1/fullcalendar.min.js'></script>
<script>
  $(document).ready(function() {
    var calendar = $('#calendar').fullCalendar({
      editable: true,
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      events: [
        {% for row in events %}
          { id : '{{row.id}}', title : '{{row.title}}', start : '{{row.start_time}}', end : '{{row.end_time}}', }, 
        {% endfor %}
      ],
      selectable: true,
      selectHelper: true,
      select: function(start, end, allDay) {
          // $("#exampleModal").modal("show");
        var title = prompt("Enter Event Title");
        if(title) {
          start=moment(start).format('YYYY-MM-DDTHH:mm:ssZ'); 
          end=moment(end).format('YYYY-MM-DDTHH:mm:ssZ'); 
          var u = "{{ url_for('calendar.insert_event') }}";
          $.ajax({
            url: "{{ url_for('calendar.insert_event') }}",
            type: "POST",
            data: {title:title, start:start, end:end},
            success: function(){
              window.location.replace("/calendar");
            }
          })
        }
      },
      editable: true,
      eventResize: function(event) {
        start = moment(event.start).format('YYYY-MM-DDTHH:mm:ssZ'); 
        end = moment(event.end).format('YYYY-MM-DDTHH:mm:ssZ'); 
        var title = event.title;
        var id = event.id;
        $.ajax({
          url: "{{ url_for('calendar.update_event') }}",
          type: "POST",
          data: {title:title, start:start, end:end, id:id},
          success:function() {
            calendar.fullCalendar('refetchEvents');
          }
        })
      },
      eventDrop: function(event) {
        start = moment(event.start).format('YYYY-MM-DDTHH:mm:ssZ'); 
        end = moment(event.end).format('YYYY-MM-DDTHH:mm:ssZ');
        var title = event.title;
        var id = event.id;  
        $.ajax({
          url: "{{ url_for('calendar.update_event') }}",
          type: "POST",
          data: {title:title, start:start, end:end, id:id},
          success: function() {
            calendar.fullCalendar('refetchEvents');
          }
        });
      },
      eventClick: function(event) {
        $('#exampleModal').modal('show');
        if(confirm("Are you sure you want to remove it?")) {
          var id = event.id;
          $.ajax({
            url: "{{ url_for('calendar.delete_event') }}",
            type: "POST",
            data: {id:id},
            success: function() {
              calendar.fullCalendar('refetchEvents');
              window.location.replace("/calendar");
            }
          })
        }
      },
    });
  });
</script>
{% endblock %}


{% block content %}
<div class="container">
  <div id="calendar"></div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Event Title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Enter Event title">
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

